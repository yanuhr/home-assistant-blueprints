blueprint:
  name: Weather Voice Assistant (Slovak)
  description: "Slovenská hlasová predpoveď pomocou REST senzora met.no"
  domain: automation
  input:
    voice_entities:
      name: Assist Zariadenia
      description: "Zoznam zariadení, ktoré môžu ohlásiť predpoveď"
      selector:
        entity:
          domain: assist_satellite
          multiple: true

trigger:
  - platform: conversation
    command:
      - aké je počasie
      - ako je vonku
      - aké je počasie vonku
      - aké je vonku počasie
      - aká je predpoveď počasia
      - aké bude počasie
      - aké dnes bude počasie

action:
  - variables:
      ts: "{{ state_attr('sensor.met_no_forecast', 'timeseries') }}"
      first: "{{ ts[0] if ts is defined and ts | length > 0 else {} }}"
      details: "{{ first['data']['instant']['details'] if 'data' in first and 'instant' in first['data'] and 'details' in first['data']['instant'] else {} }}"
      code: "{{ first['data']['next_1_hours']['summary']['symbol_code'] if 'data' in first and 'next_1_hours' in first['data'] and 'summary' in first['data']['next_1_hours'] else 'unknown' }}"
      rain: "{{ first['data']['next_1_hours']['details']['precipitation_amount'] if 'data' in first and 'next_1_hours' in first['data'] and 'details' in first['data']['next_1_hours'] else 0 }}"
      temp: "{{ details['air_temperature'] if 'air_temperature' in details else '?' }}"
      wind: "{{ details['wind_speed'] if 'wind_speed' in details else '?' }}"
      condition_text: >
        {% set map = {
          "clearsky_day": "jasno",
          "clearsky_night": "jasná noc",
          "fair_day": "polojasno",
          "fair_night": "polojasná noc",
          "partlycloudy_day": "čiastočne oblačno",
          "partlycloudy_night": "čiastočne oblačná noc",
          "cloudy": "zamračené",
          "rain": "dážď",
          "lightrain": "slabý dážď",
          "heavyrain": "silný dážď",
          "snow": "sneženie",
          "fog": "hmla",
          "rainshowers_day": "prehánky",
          "heavyrainshowers_day": "silné prehánky",
          "lightrainshowers_day": "slabé prehánky"
        } %}
        {{ map[code] if code in map else 'neznáme' }}
      matched_entity: >
        {% set all = states | selectattr('entity_id', 'search', 'assist_satellite.') | map(attribute='entity_id') | list %}
        {% set match = all | select('is_state', 'processing') | list | first %}
        {{ match if match else all[0] if all|length > 0 else '' }}
      message: >
        Aktuálne je {{ condition_text }}. Teplota {{ temp }} °C. Vietor {{ wind }} km/h.
        {% if rain | float > 0 %}
          Očakávajú sa zrážky: približne {{ rain }} mm.
        {% else %}
          Zrážky sa neočakávajú.
        {% endif %}

  - if: "{{ matched_entity != '' }}"
    then:
      - service: assist_satellite.announce
        target:
          entity_id: "{{ matched_entity }}"
        data:
          message: "{{ message }}"

mode: single
