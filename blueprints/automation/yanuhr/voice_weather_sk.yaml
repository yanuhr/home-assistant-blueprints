blueprint:
  name: Weather Voice Assistant (Slovak)
  description: >
    Slovensk√Ω hlasov√Ω asistent poƒçasia (s predikciou zr√°≈æok a v√Ωslovnos≈•ou ƒç√≠sel),
    ktor√Ω odpovie iba cez ten Assist Satellite, ktor√Ω pr√°ve spracov√°va pr√≠kaz.
  domain: automation

  input:
    voice_entities:
      name: Voice Assist Entities
      description: Zoznam va≈°ich Assist Satellite ent√≠t
      selector:
        entity:
          domain: assist_satellite
          multiple: true

trigger:
  - platform: conversation
    command:
      - ak√© je poƒçasie
      - ak√© bude poƒçasie
      - ak√° je predpoveƒè poƒçasia

action:
  - variables:
      # Pom√¥cka na prevod ƒç√≠sel 0‚Äì59 na slov√°
      number_to_words: >-
        {{ {
          0:'nula',1:'jedna',2:'dve',3:'tri',4:'≈°tyri',5:'p√§≈•',
          6:'≈°es≈•',7:'sedem',8:'osem',9:'dev√§≈•',10:'desa≈•',
          11:'jeden√°s≈•',12:'dvan√°s≈•',13:'trin√°s≈•',14:'≈°trn√°s≈•',15:'p√§tn√°s≈•',
          16:'≈°estn√°s≈•',17:'sedemn√°s≈•',18:'osemn√°s≈•',19:'dev√§tn√°s≈•',20:'dvadsa≈•',
          21:'dvadsa≈• jedna',22:'dvadsa≈• dva',23:'dvadsa≈• tri',24:'dvadsa≈• ≈°tyri',
          25:'dvadsa≈• p√§≈•',26:'dvadsa≈• ≈°es≈•',27:'dvadsa≈• sedem',28:'dvadsa≈• osem',
          29:'dvadsa≈• dev√§≈•',30:'tridsa≈•',31:'tridsa≈• jedna',32:'tridsa≈• dva',
          33:'tridsa≈• tri',34:'tridsa≈• ≈°tyri',35:'tridsa≈• p√§≈•',36:'tridsa≈• ≈°es≈•',
          37:'tridsa≈• sedem',38:'tridsa≈• osem',39:'tridsa≈• dev√§≈•',40:'≈°tyridsa≈•',
          41:'≈°tyridsa≈• jedna',42:'≈°tyridsa≈• dva',43:'≈°tyridsa≈• tri',44:'≈°tyridsa≈• ≈°tyri',
          45:'≈°tyridsa≈• p√§≈•',46:'≈°tyridsa≈• ≈°es≈•',47:'≈°tyridsa≈• sedem',48:'≈°tyridsa≈• osem',
          49:'≈°tyridsa≈• dev√§≈•',50:'p√§≈•desiat',51:'p√§≈•desiat jedna',52:'p√§≈•desiat dva',
          53:'p√§≈•desiat tri',54:'p√§≈•desiat ≈°tyri',55:'p√§≈•desiat p√§≈•',56:'p√§≈•desiat ≈°es≈•',
          57:'p√§≈•desiat sedem',58:'p√§≈•desiat osem',59:'p√§≈•desiat dev√§≈•'
        } }}

      forecast: "{{ state_attr('sensor.met_no_forecast','timeseries') }}"
      current_temp: "{{ state_attr('weather.forecast_domov','temperature') | float }}"
      wind_speed: "{{ state_attr('weather.forecast_domov','wind_speed') | float }}"

      min_temp: >-
        {% set lst = forecast[:24] | map(attribute='data.instant.details.air_temperature') | list %}
        {{ lst | min }}
      max_temp: >-
        {% set lst = forecast[:24] | map(attribute='data.instant.details.air_temperature') | list %}
        {{ lst | max }}

      precip_hours: >-
        {% set rains = forecast[:24]
           | selectattr('data.next_1_hours.details.precipitation_amount','gt',0)
           | list %}
        {{ rains }}
      total_precip: >-
        {% set vals = forecast[:24]
           | map(attribute='data.next_1_hours.details.precipitation_amount')
           | select('defined') | map('float') | list %}
        {{ vals | sum | round(1) }}

      # üìå Z√≠skaj spr√°vne ID satelitu z triggeru
      matched_entity: "{{ trigger.event.data.satellite_id if trigger.event.data.satellite_id is defined else '' }}"

      message_text: >-
        {%- set msg = '' %}
        {%- set it = current_temp | int %}
        {%- set dt = ((current_temp - it)*10) | round | int %}
        {%- set msg = msg ~ 'Aktu√°lna teplota je ' ~ number_to_words[it] %}
        {%- if dt > 0 %}{%- set msg = msg ~ ' cel√Ωch ' ~ number_to_words[dt] %}{%- endif %}
        {%- set msg = msg ~ ' stup≈àov Celzia. ' %}

        {%- set iw = wind_speed | int %}
        {%- set dw = ((wind_speed - iw)*10) | round | int %}
        {%- set msg = msg ~ 'R√Ωchlos≈• vetra je ' ~ number_to_words[iw] %}
        {%- if dw > 0 %}{%- set msg = msg ~ ' cel√Ωch ' ~ number_to_words[dw] %}{%- endif %}
        {%- set msg = msg ~ ' kilometrov za hodinu. ' %}

        {%- set mit = min_temp | int %}
        {%- set mdt = ((min_temp - mit)*10) | round | int %}
        {%- set msg = msg ~ 'Najni≈æ≈°ia teplota bude ' ~ number_to_words[mit] %}
        {%- if mdt > 0 %}{%- set msg = msg ~ ' cel√Ωch ' ~ number_to_words[mdt] %}{%- endif %}
        {%- set msg = msg ~ ' stup≈àov. ' %}

        {%- set mat = max_temp | int %}
        {%- set mdt2 = ((max_temp - mat)*10) | round | int %}
        {%- set msg = msg ~ 'Najvy≈°≈°ia teplota bude ' ~ number_to_words[mat] %}
        {%- if mdt2 > 0 %}{%- set msg = msg ~ ' cel√Ωch ' ~ number_to_words[mdt2] %}{%- endif %}
        {%- set msg = msg ~ ' stup≈àov. ' %}

        {%- if precip_hours | length > 0 %}
          {%- set msg = msg ~ 'Zr√°≈æky sa oƒçak√°vaj√∫, celkovo ' ~ total_precip ~ ' mm. ' %}
        {%- else %}
          {%- set msg = msg ~ '≈Ωiadne zr√°≈æky sa neoƒçak√°vaj√∫. ' %}
        {%- endif %}

        {{ msg }}

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ matched_entity != '' }}"
        sequence:
          - service: assist_satellite.announce
            target:
              entity_id: "{{ matched_entity }}"
            data:
              message: "{{ message_text }}"
