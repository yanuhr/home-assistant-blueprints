blueprint:
  name: KompletnÃ© sledovanie batÃ©riÃ­ s prehÄ¾adom novÃ½ch entÃ­t
  description: Sleduje stav batÃ©riÃ­, upozorÅˆuje na nÃ­zke hodnoty a umoÅ¾Åˆuje prehÄ¾adÃ¡vaÅ¥ novÃ© senzory.
  domain: automation
  input:
    check_time:
      name: ÄŒas kontroly
      description: Kedy sa mÃ¡ vykonaÅ¥ dennÃ¡ kontrola stavu batÃ©riÃ­
      default: "08:00:00"
      selector:
        time: {}
    refresh_trigger:
      name: PrepÃ­naÄ pre prehÄ¾adanie novÃ½ch entÃ­t
      description: input_boolean, ktorÃ½ aktivuje hÄ¾adanie novÃ½ch batÃ©riovÃ½ch entÃ­t
      selector:
        entity:
          domain: input_boolean
    extra_batteries:
      name: ManuÃ¡lne pridanÃ© batÃ©rie
      description: Entity, ktorÃ© nemajÃº 'battery' v ID, ale chceÅ¡ ich sledovaÅ¥
      default: []
      selector:
        entity:
          domain: sensor
          multiple: true
    excluded_batteries:
      name: VylÃºÄenÃ© batÃ©rie
      description: Entity, ktorÃ© nechceÅ¡ sledovaÅ¥ ani byÅ¥ upozornenÃ½
      default: []
      selector:
        entity:
          domain: sensor
          multiple: true
    notification_service:
      name: NotifikaÄnÃ¡ sluÅ¾ba
      description: Napr. notify.mobile_app_iphone alebo notify.telegram_user
      default: notify.persistent_notification
      selector:
        text: {}

mode: queued

trigger:
  - platform: time
    at: !input check_time
  - platform: state
    entity_id: !input refresh_trigger
    to: "on"

variables:
  notify_service: !input notification_service
  extra_batteries: !input extra_batteries
  excluded_batteries: !input excluded_batteries
  low_threshold: 15

  auto_found_batteries: >-
    {% set result = namespace(items=[]) %}
    {% for entity in states.sensor %}
      {% if ('battery' in entity.entity_id or 'bateria' in entity.entity_id)
            and (entity.state | float(default=-1) >= 0)
            and (entity.state | float(default=101) <= 100) %}
        {% set result.items = result.items + [entity.entity_id] %}
      {% endif %}
    {% endfor %}
    {{ result.items }}

  known_entities: "{{ (extra_batteries + excluded_batteries) | unique }}"
  new_entities: "{{ auto_found_batteries | reject('in', known_entities) | list }}"
  all_monitored_batteries: "{{ (auto_found_batteries + extra_batteries) | reject('in', excluded_batteries) | unique }}"

action:
  - choose:
      # Ak bol aktivovanÃ½ refresh prepÃ­naÄ
      - conditions: "{{ trigger.entity_id == refresh_trigger }}"
        sequence:
          - choose:
              - conditions: "{{ new_entities | length > 0 }}"
                sequence:
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ”‹ NovÃ© batÃ©riovÃ© entity zistenÃ©"
                      message: >
                        Boli zistenÃ© novÃ© senzory batÃ©rie, ktorÃ© zatiaÄ¾ nesledujeÅ¡ ani nevyluÄujeÅ¡:

                        {{ new_entities | join('\n') }}

                        Otvor tÃºto automatizÃ¡ciu a pridaj ich buÄ do:
                        - extra_batteries â†’ sledovaÅ¥
                        - alebo excluded_batteries â†’ ignorovaÅ¥
          - service: input_boolean.turn_off
            target:
              entity_id: !input refresh_trigger

      # Inak, ide o plÃ¡novanÃº dennÃº kontrolu batÃ©riÃ­
      - conditions: "{{ trigger.platform == 'time' }}"
        sequence:
          - repeat:
              for_each: "{{ all_monitored_batteries }}"
              sequence:
                - variables:
                    battery_entity: "{{ repeat.item }}"
                    battery_level: "{{ states(battery_entity) | float(default=100) }}"
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ battery_level < low_threshold }}"
                      sequence:
                        - service: "{{ notify_service }}"
                          data:
                            title: "Upozornenie na batÃ©riu"
                            message: >
                              ğŸ”‹ NÃ­zka batÃ©ria: {{ state_attr(battery_entity, 'friendly_name') or battery_entity }}
                              mÃ¡ iba {{ battery_level | int }} %!
