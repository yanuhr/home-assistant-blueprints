blueprint:
  name: Upozornenie na zadymenie
  description: >
    Automatiz√°cia, ktor√° odosiela notifik√°cie pri detekcii dymu a jeho z√°niku.
    Voliteƒæne m√¥≈æe spusti≈• alarmov√∫ akciu (napr. sir√©na, sc√©na) pri zadymen√≠.
    Vhodn√© pre viacero Aqara detektorov dymu (napr. JY-GZ-01AQ).

  domain: automation
  input:
    smoke_sensors:
      name: Detektory dymu
      description: Vyberte senzory dymu, ktor√© chcete monitorova≈•
      selector:
        entity:
          domain: binary_sensor
          device_class: smoke
          multiple: true

    notification_services:
      name: Notifikaƒçn√© slu≈æby
      description: >
        Zadajte n√°zvy notifikaƒçn√Ωch slu≈æieb (napr. notify.mobile_app_jan).
        M√¥≈æete zada≈• viacero slu≈æieb, ka≈æd√∫ na nov√Ω riadok.
      default: []
      selector:
        text:
          multiple: true

    alarm_mode:
      name: Aktivova≈• alarm
      description: >
        Ak je aktivovan√©, spust√≠ sa definovan√° alarmov√° akcia pri zadymen√≠.
      default: false
      selector:
        boolean: {}

    custom_alert_actions:
      name: Alarmov√° akcia (voliteƒæn√°)
      description: >
        Voliteƒæn√° akcia, ktor√° sa spust√≠ pri zadymen√≠ ‚Äì napr√≠klad skript alebo sc√©na.
      default: []
      selector:
        entity:
          domain: [script, scene]
          multiple: true

    repeat_notifications:
      name: Opakovan√© notifik√°cie
      description: >
        Ak je aktivovan√©, mobiln√© notifik√°cie sa bud√∫ opakova≈• ka≈æd√Ωch 5 min√∫t, pokiaƒæ
        zost√°va detekovan√Ω dym. Satelity sa neopakuj√∫.
      default: false
      selector:
        boolean: {}

    assist_satellites:
      name: Assist Satellites (voliteƒæn√©)
      description: >
        Vyberte Assist Satellite zariadenia pre hlasov√© hl√°senia.
        M√¥≈æete vybra≈• viacero satelitov.
      default: []
      selector:
        entity:
          domain: assist_satellite
          multiple: true

    preannounce_enabled:
      name: Povoli≈• chime pred hl√°≈°kou
      description: >
        Ak je aktivovan√©, pred hl√°≈°kou sa prehr√° chime (zvukov√Ω sign√°l).
      default: true
      selector:
        boolean: {}

    satellite_playback_mode:
      name: Re≈æim prehr√°vania satelitov
      description: >
        Sequential: Satelity prehr√°vaj√∫ jeden po druhom (najstabilnej≈°ie).
        Parallel: V≈°etky satelity prehr√°vaj√∫ naraz (r√Ωchlej≈°ie, ale m√¥≈æe sp√¥sobi≈• probl√©my).
      default: sequential
      selector:
        select:
          options:
            - sequential
            - parallel

    use_room_names:
      name: Pou≈æi≈• n√°zvy miestnost√≠
      description: >
        Ak je aktivovan√©, v hl√°seniach sa pou≈æij√∫ n√°zvy miestnost√≠ namiesto n√°zvov senzorov.
        N√°zvy miestnost√≠ sa z√≠skaj√∫ z oblasti (area) priradenej k senzoru.
      default: false
      selector:
        boolean: {}

    max_satellite_announcements:
      name: Maxim√°lny poƒçet satelitn√Ωch hl√°sen√≠
      description: >
        Maxim√°lny poƒçet satelitn√Ωch hl√°sen√≠ na jeden incident (prv√Ω + voliteƒæne druh√Ω).
        Nastavte 0 pre vypnutie satelitn√Ωch hl√°sen√≠.
      default: 2
      selector:
        number:
          min: 0
          max: 5
          step: 1

    second_announce_delay_minutes:
      name: Oneskorenie druh√©ho satelitn√©ho hl√°senia (min√∫ty)
      description: >
        Po koƒæk√Ωch min√∫tach sa prehr√° druh√© satelitn√© hl√°senie, ak dym st√°le trv√°.
      default: 5
      selector:
        number:
          min: 1
          max: 60
          step: 1

    daily_report_time:
      name: ƒåas denn√©ho reportu
      description: >
        ƒåas, kedy sa po≈°le denn√Ω report o nedostupn√Ωch senzoroch.
      default: "08:00:00"
      selector:
        time: {}

    all_unavailable_grace_minutes:
      name: Grace period pre v≈°etky nedostupn√© senzory (min√∫ty)
      description: >
        Ak s√∫ v≈°etky senzory nedostupn√©, po≈°le sa notifik√°cia len ak tento stav trv√° aspo≈à totoƒæko min√∫t.
        Chr√°ni pred spamom pri HA re≈°tarte alebo update Windows.
      default: 10
      selector:
        number:
          min: 1
          max: 60
          step: 1

trigger:
  - platform: state
    entity_id: !input smoke_sensors
    from: "off"
    to: "on"
    id: smoke_on

  - platform: state
    entity_id: !input smoke_sensors
    from: "on"
    to: "off"
    id: smoke_off

  - platform: time
    at: !input daily_report_time
    id: daily_report

action:
  - variables:
      smoke_sensors: !input smoke_sensors
      notification_services: !input notification_services
      alarm_mode: !input alarm_mode
      custom_alert_actions: !input custom_alert_actions
      repeat_notifications: !input repeat_notifications
      assist_satellites: !input assist_satellites
      preannounce_enabled: !input preannounce_enabled
      satellite_playback_mode: !input satellite_playback_mode
      use_room_names: !input use_room_names
      max_satellite_announcements: !input max_satellite_announcements
      second_announce_delay_minutes: !input second_announce_delay_minutes
      all_unavailable_grace_minutes: !input all_unavailable_grace_minutes
      active_smoke_entities: "{{ smoke_sensors | select('is_state', 'on') | list }}"
      active_smoke_count: "{{ active_smoke_entities | length }}"
      active_smoke_list: >-
        {% set ns = namespace(names=[]) %}
        {% for sensor in active_smoke_entities %}
          {% if use_room_names %}
            {% set area = area_name(sensor) %}
            {% set name = area if area else state_attr(sensor, 'friendly_name') | default(sensor) %}
          {% else %}
            {% set name = state_attr(sensor, 'friendly_name') | default(sensor) %}
          {% endif %}
          {% set ns.names = ns.names + [name] %}
        {% endfor %}
        {{ ns.names | join(', ') }}
      sensor_name: >-
        {% if trigger is defined and trigger.entity_id is defined %}
          {{ state_attr(trigger.entity_id, 'friendly_name') | default(trigger.entity_id) }}
        {% else %}
          Nezn√°my senzor
        {% endif %}
      room_name: >-
        {% if trigger is defined and trigger.entity_id is defined and use_room_names %}
          {% set area = area_name(trigger.entity_id) %}
          {{ area if area else sensor_name }}
        {% else %}
          {{ sensor_name }}
        {% endif %}

  - choose:
      - alias: Zadymenie
        conditions:
          - condition: trigger
            id: smoke_on
        sequence:
          - variables:
              other_active_count: >-
                {% if trigger.entity_id is defined %}
                  {{ (smoke_sensors | reject('equalto', trigger.entity_id) | select('is_state', 'on') | list | length) }}
                {% else %}
                  0
                {% endif %}
              announcement_message: >-
                {% if active_smoke_count | int > 1 %}
                  Pozor, bol detegovan√Ω dym v: {{ active_smoke_list }}
                {% else %}
                  Pozor, bol detegovan√Ω dym v {{ room_name }}
                {% endif %}
              notification_message: >-
                {% if active_smoke_count | int > 1 %}
                  Detektory v {{ active_smoke_list }} zaznamenali dym!
                {% else %}
                  Detektor {{ room_name }} zaznamenal dym!
                {% endif %}
          - if:
              - condition: template
                value_template: "{{ other_active_count | int > 0 }}"
            then:
              - stop: "Incident u≈æ be≈æ√≠, tento beh sa ukonƒçuje"
          - parallel:
              - if:
                  - condition: template
                    value_template: "{{ notification_services | length > 0 }}"
                then:
                  - repeat:
                      for_each: "{{ notification_services }}"
                      sequence:
                        - service: "{{ repeat.item }}"
                          data:
                            title: "üö® Detekovan√Ω dym"
                            message: "{{ notification_message }}"
                            data:
                              priority: high
                              importance: max
                              channel: emergency
              - if:
                  - condition: template
                    value_template: "{{ alarm_mode and (custom_alert_actions | length > 0) }}"
                then:
                  - repeat:
                      for_each: "{{ custom_alert_actions }}"
                      sequence:
                        - service: homeassistant.turn_on
                          target:
                            entity_id: "{{ repeat.item }}"
              - if:
                  - condition: template
                    value_template: "{{ (assist_satellites | length > 0) and (max_satellite_announcements | int >= 1) }}"
                then:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ satellite_playback_mode == 'parallel' }}"
                        sequence:
                          - service: assist_satellite.announce
                            target:
                              entity_id: "{{ assist_satellites }}"
                            data:
                              message: "{{ announcement_message }}"
                              preannounce: "{{ preannounce_enabled }}"
                            continue_on_error: true
                      - conditions:
                          - condition: template
                            value_template: "{{ satellite_playback_mode == 'sequential' }}"
                        sequence:
                          - repeat:
                              for_each: "{{ assist_satellites }}"
                              sequence:
                                - service: assist_satellite.announce
                                  target:
                                    entity_id: "{{ repeat.item }}"
                                  data:
                                    message: "{{ announcement_message }}"
                                    preannounce: "{{ preannounce_enabled }}"
                                  continue_on_error: true
          - if:
              - condition: template
                value_template: "{{ (assist_satellites | length > 0) and (max_satellite_announcements | int >= 2) }}"
            then:
              - delay:
                  minutes: "{{ second_announce_delay_minutes | int }}"
              - if:
                  - condition: template
                    value_template: "{{ smoke_sensors | select('is_state', 'on') | list | length > 0 }}"
                then:
                  - variables:
                      delayed_announcement_message: >-
                        {% set active = smoke_sensors | select('is_state', 'on') | list %}
                        {% set ns = namespace(names=[]) %}
                        {% for sensor in active %}
                          {% if use_room_names %}
                            {% set area = area_name(sensor) %}
                            {% set name = area if area else state_attr(sensor, 'friendly_name') | default(sensor) %}
                          {% else %}
                            {% set name = state_attr(sensor, 'friendly_name') | default(sensor) %}
                          {% endif %}
                          {% set ns.names = ns.names + [name] %}
                        {% endfor %}
                        {% if ns.names | length > 1 %}
                          St√°le detegovan√Ω dym v: {{ ns.names | join(', ') }}
                        {% else %}
                          St√°le detegovan√Ω dym v {{ ns.names[0] if ns.names | length > 0 else room_name }}
                        {% endif %}
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ satellite_playback_mode == 'parallel' }}"
                        sequence:
                          - service: assist_satellite.announce
                            target:
                              entity_id: "{{ assist_satellites }}"
                            data:
                              message: "{{ delayed_announcement_message }}"
                              preannounce: "{{ preannounce_enabled }}"
                            continue_on_error: true
                      - conditions:
                          - condition: template
                            value_template: "{{ satellite_playback_mode == 'sequential' }}"
                        sequence:
                          - repeat:
                              for_each: "{{ assist_satellites }}"
                              sequence:
                                - service: assist_satellite.announce
                                  target:
                                    entity_id: "{{ repeat.item }}"
                                  data:
                                    message: "{{ delayed_announcement_message }}"
                                    preannounce: "{{ preannounce_enabled }}"
                                  continue_on_error: true
          - if:
              - condition: template
                value_template: "{{ repeat_notifications }}"
            then:
              - repeat:
                  while:
                    - condition: template
                      value_template: "{{ smoke_sensors | select('is_state', 'on') | list | length > 0 }}"
                  sequence:
                    - delay:
                        minutes: 5
                    - if:
                        - condition: template
                          value_template: "{{ smoke_sensors | select('is_state', 'on') | list | length == 0 }}"
                      then:
                        - stop: "Dym u≈æ netrv√° ‚Äì neodosielam ƒèal≈°iu repeat notifik√°ciu"
                    - variables:
                        active_smoke_entities: "{{ smoke_sensors | select('is_state', 'on') | list }}"
                        active_smoke_count: "{{ active_smoke_entities | length }}"
                        active_smoke_list: >-
                          {% set ns = namespace(names=[]) %}
                          {% for sensor in active_smoke_entities %}
                            {% if use_room_names %}
                              {% set area = area_name(sensor) %}
                              {% set name = area if area else state_attr(sensor, 'friendly_name') | default(sensor) %}
                            {% else %}
                              {% set name = state_attr(sensor, 'friendly_name') | default(sensor) %}
                            {% endif %}
                            {% set ns.names = ns.names + [name] %}
                          {% endfor %}
                          {{ ns.names | join(', ') }}
                        notification_message: >-
                          {% if active_smoke_count | int > 1 %}
                            St√°le detegovan√Ω dym v: {{ active_smoke_list }}
                          {% else %}
                            St√°le detegovan√Ω dym v {{ active_smoke_list if active_smoke_list else room_name }}
                          {% endif %}
                    - if:
                        - condition: template
                          value_template: "{{ notification_services | length > 0 }}"
                      then:
                        - repeat:
                            for_each: "{{ notification_services }}"
                            sequence:
                              - service: "{{ repeat.item }}"
                                data:
                                  title: "üö® St√°le detegovan√Ω dym"
                                  message: "{{ notification_message }}"
                                  data:
                                    priority: high
                                    importance: max
                                    channel: emergency

      - alias: Koniec zadymenia
        conditions:
          - condition: trigger
            id: smoke_off
          - condition: template
            value_template: "{{ smoke_sensors | select('is_state', 'on') | list | length == 0 }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ notification_services | length > 0 }}"
            then:
              - repeat:
                  for_each: "{{ notification_services }}"
                  sequence:
                    - service: "{{ repeat.item }}"
                      data:
                        title: "‚ÑπÔ∏è Dym zmizol"
                        message: "V≈°etky detektory u≈æ nezaznamen√°vaj√∫ dym."
                        data:
                          priority: default
                          importance: high

      - alias: Denn√Ω report o nedostupn√Ωch senzoroch
        conditions:
          - condition: trigger
            id: daily_report
        sequence:
          - variables:
              total: "{{ smoke_sensors | length }}"
              unavail_count: >-
                {% set ns = namespace(count=0, lines=[]) %}
                {% for sensor in smoke_sensors %}
                  {% set state = states(sensor) %}
                  {% if state in ['unavailable', 'unknown'] %}
                    {% set ns.count = ns.count + 1 %}
                    {% if use_room_names %}
                      {% set area = area_name(sensor) %}
                      {% set name = area if area else state_attr(sensor, 'friendly_name') | default(sensor) %}
                    {% else %}
                      {% set name = state_attr(sensor, 'friendly_name') | default(sensor) %}
                    {% endif %}
                    {% set ns.lines = ns.lines + [name] %}
                  {% endif %}
                {% endfor %}
                {{ ns.count }}
              report_lines: >-
                {% set ns = namespace(count=0, lines=[]) %}
                {% for sensor in smoke_sensors %}
                  {% set state = states(sensor) %}
                  {% if state in ['unavailable', 'unknown'] %}
                    {% set ns.count = ns.count + 1 %}
                    {% if use_room_names %}
                      {% set area = area_name(sensor) %}
                      {% set name = area if area else state_attr(sensor, 'friendly_name') | default(sensor) %}
                    {% else %}
                      {% set name = state_attr(sensor, 'friendly_name') | default(sensor) %}
                    {% endif %}
                    {% set ns.lines = ns.lines + [name] %}
                  {% endif %}
                {% endfor %}
                {{ ns.lines | join(', ') }}
          - if:
              - condition: template
                value_template: "{{ (unavail_count | int > 0) and (unavail_count | int < total | int) and (notification_services | length > 0) }}"
            then:
              - repeat:
                  for_each: "{{ notification_services }}"
                  sequence:
                    - service: "{{ repeat.item }}"
                      data:
                        title: "‚ö†Ô∏è Denn√Ω report: Nedostupn√© senzory dymu"
                        message: "{{ report_lines }}"
                        data:
                          priority: default
                          importance: high
                          channel: warning
          - if:
              - condition: template
                value_template: >-
                  {% set ns = namespace(grace_ok=true) %}
                  {% if (total | int > 0) and (unavail_count | int == total | int) %}
                    {% for sensor in smoke_sensors %}
                      {% set state = states(sensor) %}
                      {% if state in ['unavailable', 'unknown'] %}
                        {% set last_changed = states[sensor].last_changed %}
                        {% if last_changed %}
                          {% set duration_minutes = ((now() - last_changed).total_seconds() / 60) | int %}
                          {% if duration_minutes < all_unavailable_grace_minutes | int %}
                            {% set ns.grace_ok = false %}
                          {% endif %}
                        {% else %}
                          {% set ns.grace_ok = false %}
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                    {{ ns.grace_ok and (notification_services | length > 0) }}
                  {% else %}
                    false
                  {% endif %}
            then:
              - repeat:
                  for_each: "{{ notification_services }}"
                  sequence:
                    - service: "{{ repeat.item }}"
                      data:
                        title: "‚ö†Ô∏è V≈°etky dymov√© senzory nedostupn√©"
                        message: "Vyzer√° to na v√Ωpadok siete/koordin√°tora. Skontroluj HA/koordin√°tor."
                        data:
                          priority: high
                          importance: high
                          channel: warning

mode: parallel
