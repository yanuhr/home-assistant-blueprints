blueprint:
  name: Upozornenie na výmenu filtra (HA 2026.1 / stable)
  description: >
    Pošle upozornenie, keď je binary_sensor "replace_filter" v stave ON.
    - Okamžite pri prechode OFF -> ON (voliteľné)
    - Denne v čase, kým je stále ON
    - Memory (input_text) drží zoznam aktuálne aktívnych senzorov, aby sa "immediate" neposielal duplicitne.
    - Manuálne spustenie sa správa ako denná kontrola.

  domain: automation

  input:
    filter_sensors:
      name: Senzory filtra (binary_sensor)
      selector:
        entity:
          domain: binary_sensor
          multiple: true

    memory_helper:
      name: Memory helper (input_text)
      description: Musí obsahovať JSON zoznam, napr. []
      selector:
        entity:
          domain: input_text

    notification_services:
      name: Notifikačné služby
      description: Každú službu (napr. notify.mobile_app_xyz) na nový riadok
      default: []
      selector:
        text:
          multiple: true

    use_persistent_fallback:
      name: Persistent fallback
      description: Ak nie sú notify služby, vytvorí persistent notifikáciu v HA
      default: true
      selector:
        boolean: {}

    notification_time:
      name: Čas dennej notifikácie
      default: "08:00:00"
      selector:
        time: {}

    immediate_notification:
      name: Okamžitá notifikácia pri OFF->ON
      default: true
      selector:
        boolean: {}

    title:
      name: Názov notifikácie
      default: "Výmena filtra"
      selector:
        text: {}

    debug:
      name: Debug (persistent info pri manuálnom teste)
      default: false
      selector:
        boolean: {}

trigger:
  - platform: state
    entity_id: !input filter_sensors
    from: "off"
    to: "on"
    id: became_on

  - platform: time
    at: !input notification_time
    id: daily

variables:
  sensor_entities: !input filter_sensors
  memory_helper: !input memory_helper
  notify_services: !input notification_services
  use_persistent: !input use_persistent_fallback
  immediate: !input immediate_notification
  title: !input title
  debug: !input debug

  # Manuálne spustenie nemá vždy trigger.id -> spravíme z neho "manual"
  run_id: >-
    {% if trigger is defined and trigger.id is defined and trigger.id %}
      {{ trigger.id }}
    {% else %}
      manual
    {% endif %}

  notify_services_filtered: >-
    {% set services = notify_services | default([]) %}
    {{ services | map('string') | map('trim') | reject('equalto', '') | unique | list }}

  active_sensors: >-
    {{ expand(sensor_entities) | selectattr('state', 'eq', 'on') | list }}

  active_entity_ids: >-
    {{ active_sensors | map(attribute='entity_id') | list }}

  # Memory list (očakáva sa JSON list, ideálne [] keď je prázdny)
  memory_list: >-
    {% set raw = states(memory_helper) | string | trim %}
    {% if raw in ['', 'unknown', 'unavailable', 'none'] %}
      []
    {% elif raw | length >= 2 and raw[0] == '[' and raw[-1] == ']' %}
      {{ raw | from_json }}
    {% else %}
      []
    {% endif %}

  message_text: >-
    {% if active_sensors | length == 1 %}
      {% set s = active_sensors[0] %}
      {% set a = area_name(s.entity_id) %}
      {{ (a or 'Neznáma miestnosť') ~ ' – ' ~ s.name ~ ': vymeň filter.' }}
    {% else %}
      Vymeň filter v týchto čističkách:
      {% for s in active_sensors %}
        {% set a = area_name(s.entity_id) %}
        - {{ (a or 'Neznáma miestnosť') ~ ' – ' ~ s.name }}
      {% endfor %}
    {% endif %}

  # Kedy poslať notifikáciu:
  # - daily: keď je aspoň 1 aktívny
  # - manual: rovnako ako daily (aby sa dalo testovať)
  # - became_on: len ak immediate=true a daný entity_id ešte nebol v memory_list
  should_notify: >-
    {% if run_id in ['daily', 'manual'] %}
      {{ active_sensors | length > 0 }}
    {% elif run_id == 'became_on' %}
      {{ immediate and (trigger.entity_id not in memory_list) }}
    {% else %}
      false
    {% endif %}

  next_memory: >-
    {{ active_entity_ids | unique | list }}

mode: queued
max: 10

action:
  - if:
      - condition: template
        value_template: "{{ debug and run_id == 'manual' }}"
    then:
      - service: persistent_notification.create
        data:
          notification_id: "filter_debug"
          title: "Filter Debug"
          message: >-
            run_id={{ run_id }}
            active={{ active_entity_ids | join(', ') if active_entity_ids|length else 'none' }}
            memory={{ memory_list | join(', ') if memory_list|length else '[]' }}
            should_notify={{ should_notify }}

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ should_notify }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notify_services_filtered | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ notify_services_filtered }}"
                      sequence:
                        - service: "{{ repeat.item }}"
                          data:
                            title: "{{ title }}"
                            message: "{{ message_text }}"
            default:
              - if:
                  - condition: template
                    value_template: "{{ use_persistent }}"
                then:
                  - service: persistent_notification.create
                    data:
                      notification_id: "filter_replace"
                      title: "{{ title }}"
                      message: "{{ message_text }}"

  # Memory vždy zosynchronizujeme na aktuálne ON senzory
  - service: input_text.set_value
    target:
      entity_id: !input memory_helper
    data:
      value: "{{ next_memory | to_json }}"
