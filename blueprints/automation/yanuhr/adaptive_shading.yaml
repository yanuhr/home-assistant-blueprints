blueprint:
  name: Adaptívne tienenie - viac miestností (zdieľaný svetelný senzor)
  description: >
    Automatické ovládanie roliet pre viacero miestností na základe jedného senzora osvetlenia.
    Zohľadňuje otvorené okná, úroveň osvetlenia, čas a západ slnka. Odosiela notifikácie pri otvorenom okne.

  domain: automation
  input:
    lux_sensor:
      name: Senzor osvetlenia (spoločný)
      selector:
        entity:
          domain: sensor
          device_class: illuminance

    morning_trigger_time:
      name: Ranný čas spustenia
      default: "07:30:00"
      selector:
        time: {}

    cover_configs:
      name: Miestnosti a zariadenia
      description: >
        Zoznam miestností. Každá položka musí obsahovať názov, senzor okna a roletu.
      selector:
        object: {}

    notify_user1:
      name: Notifikácia - Používateľ 1 (voliteľné)
      default: ""
      selector:
        text: {}

    notify_user2:
      name: Notifikácia - Používateľ 2 (voliteľné)
      default: ""
      selector:
        text: {}

trigger:
  - platform: time
    at: !input morning_trigger_time

  - platform: numeric_state
    entity_id: !input lux_sensor
    below: 600
    for:
      minutes: 5

  - platform: numeric_state
    entity_id: !input lux_sensor
    above: 800
    for:
      minutes: 5

condition:
  - condition: time
    after: !input morning_trigger_time
  - condition: sun
    before: sunset

action:
  - variables:
      lux_sensor_id: !input lux_sensor
      lux: "{{ states(lux_sensor_id) | float(0) }}"
      rooms: !input cover_configs
      open_windows: []
      after_sunset: "{{ state_attr('sun.sun', 'elevation') | float(1) < 0 }}"
      notify1: !input notify_user1
      notify2: !input notify_user2

  - repeat:
      for_each: "{{ rooms }}"
      sequence:
        - variables:
            name: "{{ repeat.item.name }}"
            window_sensor: "{{ repeat.item.window_sensor }}"
            cover: "{{ repeat.item.cover }}"
            window_open: "{{ is_state(repeat.item.window_sensor, 'on') }}"
            window_closed: "{{ is_state(repeat.item.window_sensor, 'off') }}"

        - choose:
            - alias: "Ráno otvorenie"
              conditions:
                - condition: template
                  value_template: "{{ trigger.platform == 'time' and lux > 800 and not after_sunset }}"
              sequence:
                - service: cover.open_cover
                  target:
                    entity_id: "{{ cover }}"

            - alias: "Stmievanie - zhromaždiť otvorené okná"
              conditions:
                - condition: template
                  value_template: "{{ lux < 600 and window_open and not after_sunset }}"
              sequence:
                - variables:
                    open_windows: "{{ open_windows + [name] }}"

            - alias: "Stmievanie - zatvorenie po zavretí okna"
              conditions:
                - condition: template
                  value_template: "{{ lux < 600 and not after_sunset and window_open }}"
              sequence:
                - wait_for_trigger:
                    - platform: state
                      entity_id:
                        - "{{ repeat.item.window_sensor }}"
                      to: "off"
                  timeout:
                    minutes: 5
                  continue_on_timeout: false
                - delay:
                    seconds: 30
                - service: cover.close_cover
                  target:
                    entity_id: "{{ cover }}"

            - alias: "Rozjasnenie - otvorenie"
              conditions:
                - condition: template
                  value_template: "{{ lux > 800 and not after_sunset }}"
              sequence:
                - service: cover.open_cover
                  target:
                    entity_id: "{{ cover }}"

            - alias: "Zatvorenie pred západom slnka"
              conditions:
                - condition: sun
                  before: sunset
                  before_offset: "-00:30:00"
                - condition: template
                  value_template: "{{ window_closed }}"
              sequence:
                - service: cover.close_cover
                  target:
                    entity_id: "{{ cover }}"

  - if:
      - condition: template
        value_template: "{{ open_windows | length > 0 }}"
    then:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ notify1 | length > 0 }}"
            sequence:
              - service: "{{ notify1 }}"
                data:
                  title: "Upozornenie: otvorené okná"
                  message: >-
                    Vonku sa stmieva a nasledujúce miestnosti majú otvorené okná,
                    preto sa rolety nezatiahli: {{ open_windows | join(', ') }}
          - conditions:
              - condition: template
                value_template: "{{ notify2 | length > 0 }}"
            sequence:
              - service: "{{ notify2 }}"
                data:
                  title: "Upozornenie: otvorené okná"
                  message: >-
                    Vonku sa stmieva a nasledujúce miestnosti majú otvorené okná,
                    preto sa rolety nezatiahli: {{ open_windows | join(', ') }}

mode: single